name: Gradle Deployment

on:
  push:
    branches: [ "master" ]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: deploy
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH and Deploy
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/kds_rsa
          chmod 600 ~/.ssh/kds_rsa
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/kds_rsa admin@$SERVER_IP << 'EOF'
            export SQL_URL="$SQL_URL"
            export SQL_USERNAME="$SQL_USERNAME"
            export SQL_PASSWORD="$SQL_PASSWORD"
            cd kds-app
            git pull
            ./gradlew clean build -x test

            # Удаляем старый образ (если нужно)
            docker image rm kds-app_kds-app:latest || true

            # Собираем новый образ
            docker run -d \
              --name kds-app-new \
              --network kds-network \
              -p 8001:8000 \
              -e SQL_URL=jdbc:postgresql://kds-db:5432/kds \
              -e SQL_USERNAME="$SQL_USERNAME" \
              -e SQL_PASSWORD="$SQL_PASSWORD" \
              kds-app_kds-app:latest

            # Ждём 10 секунд для запуска приложения
            sleep 40

            # Проверяем health check нового контейнера
            if curl -v http://localhost:8001/actuator/health | grep -q '"status":"UP"'; then
              echo "New container is healthy, proceeding with deployment"

              # Перезапускаем новый контейнер с правильным именем и портом
              docker stop kds-app-new
              echo "Test container was removed"
            
              # Останавливаем и удаляем старый контейнер
              docker stop kds-app || true
              docker rm kds-app || true
              echo "Previous container was removed"

              docker run -d \
                --name kds-app \
                --network kds-network \
                -p 8000:8000 \
                -e SQL_URL=jdbc:postgresql://kds-db:5432/kds \
                -e SQL_USERNAME="$SQL_USERNAME" \
                -e SQL_PASSWORD="$SQL_PASSWORD" \
                kds-app_kds-app:latest
              
              echo "Deployment successful"
            else
              echo "New container failed health check, rolling back"
              docker logs kds-app-new
              docker stop kds-app-new || true
              docker rm kds-app-new || true
              exit 1
            fi          
          EOF
